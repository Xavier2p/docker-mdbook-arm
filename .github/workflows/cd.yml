name: Continuous Delivery

on:
    workflow_dispatch:
    schedule:
        - cron: '11 11 */8 * *'
    push:
        branches:
            - main
        paths-ignore:
            - '**.md'

env:
    DOCKER_BASE_NAME: ghcr.io/xavier2p/mdbook
    TAG_NAME_LATEST: latest
    BASE_IMAGE: alpine:3.16

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    hadolint:
        uses: peaceiris/workflows/.github/workflows/hadolint.yml@v0.19.1

    docker:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        permissions:
            actions: write
            contents: read
            packages: write
        env:
            DOCKER_CLI_EXPERIMENTAL: enabled
            DOCKER_BUILDKIT: 1
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            # - name: Set env
            #   run: |
            #       MDBOOK_VERSION="$(make get-mdbook-version)"
            #       TAG_NAME="v${MDBOOK_VERSION}"
            #       {
            #         echo "MDBOOK_VERSION=${MDBOOK_VERSION}"
            #       } >> "${GITHUB_ENV}"

            - name: Get mdbook version
              id: get-mdbook-version
              run: echo "::set-output name=version::$(make get-mdbook-version)"

            - name: Set up QEMU
              uses: docker/setup-qemu-action@v2

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            # - name: Build image
            #   run: |
            #       docker buildx build . \
            #           --tag "${PKG_TAG}" \
            #           --build-arg MDBOOK_VERSION="${MDBOOK_VERSION}" \
            #           --build-arg BASE_IMAGE="${BASE_IMAGE}" \
            #           --output 'type=docker'

            # - name: Tag latest
            #   run: docker tag "${PKG_TAG}" "${PKG_TAG_LATEST}"

            # - name: Check images
            #   run: docker images

            # - name: Check version
            #   run: docker run --rm "${PKG_TAG}" --version

            - name: Log in to GitHub Container Registry
              uses: docker/login-action@v2
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            # - name: Push to GitHub Packages
            #   run: |
            #       docker push "${PKG_TAG}"
            #       docker push "${PKG_TAG_LATEST}"

            - name: Build and Push
              uses: docker/build-push-action@v2
              env:
                  PKG_TAG: '${{ env.DOCKER_BASE_NAME }}:v${{ env.MDBOOK_VERSION }}'
                  MDBOOK_VERSION: 'v${{ steps.get-mdbook-version.outputs.version }}'
                  PKG_TAG_LATEST: '${{ env.DOCKER_BASE_NAME }}:${{ env.TAG_NAME_LATEST }}'
              with:
                  context: .
                  file: ./Dockerfile
                  tags: |
                      ${{ env.PKG_TAG }}
                      ${{ env.PKG_TAG_LATEST }}
                  platforms: linux/arm64
                  build-args: |
                      MDBOOK_VERSION=${{ env.MDBOOK_VERSION }}
                      BASE_IMAGE=${{ env.BASE_IMAGE }}
                  push: true
